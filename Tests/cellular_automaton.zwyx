_import:"utilities_lib"


CellularAutomaton~{
        rule~int
        iters~int
        wrput~@WriteNF
        ;~{
                ruleTableBuffer~bytes.8
                ruleTable~String.{
                        setBuffer:@ruleTableBuffer
                        counter.{remainder~int:rule end:8 do:@{
                                write.c:{remainder%2}
                                remainder:{remainder/2}
                        } ; }
                }
                
                stateBuffer~bytes.22
                state~String.{
                        setBuffer:@stateBuffer
                        write.{
                                c:0
                                c:0 c:0 c:0 c:0 c:1 c:0 c:0 c:0 c:0 c:0
                                c:0 c:0 c:0 c:0 c:0 c:0 c:0 c:0 c:0 c:0
                                c:0
                        }
                }
                
                counter.{end:iters do:@{
                        prevCell~int:0
                        counter.{start:1 end:21 do:@{
                                {state.get:i = 1}?{
                                        wrput.c:"|"
                                }^{
                                        wrput.c:"."
                                }
                                currCell~int:ruleTable.get:state.get.{
                                        {$:{i-1} ;} + {{$:i ;} * 2} + {{$:{i+1} ;} * 4}
                                
                                }
                                state.set.{el:prevCell at:{i-1} ;}
                                prevCell:currCell
                        } ; }
                        
                        state.set.{el:prevCell at:20 ;}
                        wrput.endl
                } ; }
        }
}

;~{
        File.{
                name:"output.txt"
                open
                write.{
                        CellularAutomaton.{
                                rule:110
                                iters:10
                                wrput:@$.2
                                ;
                        }
                }
                close
        }
        print.{
                CellularAutomaton.{
                        rule:110
                        iters:10
                        wrput:@$.2
                        ;
                }
        }
}

